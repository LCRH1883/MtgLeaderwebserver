{{define "content"}}
<h1>Users</h1>
<form method="get" action="/admin/users" class="search-row">
  <input type="search" name="q" placeholder="Search by email, username, or ID" value="{{.Query}}" />
  <button type="submit">Search</button>
  {{if .Query}}<a class="inline-link" href="/admin/users">Clear</a>{{end}}
</form>
{{if .Error}}<div class="alert">{{.Error}}</div>{{end}}
{{if .Notice}}<div class="notice">{{.Notice}}</div>{{end}}
<div class="card">
  <table class="table">
    <thead>
      <tr>
        <th>ID</th>
        <th>Email</th>
        <th>Username</th>
        <th>Status</th>
        <th>Joined</th>
        <th>Last Login</th>
        <th>Reset Password</th>
        <th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {{range .Users}}
      <tr>
        <td class="mono">{{.ID}}</td>
        <td>{{if .Email}}{{.Email}}{{else}}<span class="muted">â€”</span>{{end}}</td>
        <td>{{.Username}}</td>
        <td>{{.Status}}</td>
        <td>{{.JoinedAt}}</td>
        <td>{{.LastLogin}}</td>
        <td>
          <button type="button" class="ghost reset-button" data-user-id="{{.ID}}" data-user-email="{{.Email}}" data-username="{{.Username}}">Reset</button>
        </td>
        <td>
          <button type="button" class="danger delete-button" data-user-id="{{.ID}}" data-user-email="{{.Email}}" data-username="{{.Username}}">Delete</button>
        </td>
      </tr>
      {{end}}
    </tbody>
  </table>
  {{if and (not .Users) .Query}}
    <p class="muted">No users match "{{.Query}}".</p>
  {{end}}
</div>

<dialog id="reset-dialog" class="modal">
  <form method="post" action="/admin/users/reset" id="reset-form">
    <div class="modal-header">
      <h2>Reset Password</h2>
      <p class="muted">Choose how to deliver a one-time reset link.</p>
    </div>
    <div class="modal-body stack">
      <input type="hidden" name="user_id" id="reset-user-id" />
      <input type="hidden" name="q" value="{{.Query}}" />
      <input type="hidden" name="action" id="reset-action" value="send_user" />

      <div>
        <div class="label">User</div>
        <div class="pill" id="reset-user-label">User</div>
      </div>

      <label class="radio-row">
        <input type="radio" name="mode" value="send_user" checked />
        <span>Send reset link to the user's email</span>
      </label>
      <div class="inline-note" id="reset-user-email"></div>

      <label class="radio-row">
        <input type="radio" name="mode" value="send_other" />
        <span>Send reset link to another email</span>
      </label>
      <input name="deliver_to" id="reset-deliver-to" type="email" placeholder="other@example.com" />

      <label class="radio-row">
        <input type="radio" name="mode" value="update_email" />
        <span>Update the user's email</span>
      </label>
      <input name="new_email" id="reset-new-email" type="email" placeholder="new@email.com" />

      {{if .HasSMTP}}
      <label>
        <div class="label">From Alias</div>
        <select name="from_alias" id="reset-from-alias">
          {{range .FromAliases}}
            <option value="{{.}}">{{.}}</option>
          {{end}}
        </select>
      </label>
      {{else}}
      <div class="pill-warning">SMTP not configured. Set it up in Email settings.</div>
      {{end}}
    </div>
    <div class="modal-actions">
      <button type="button" class="ghost" id="reset-cancel">Cancel</button>
      <button type="submit" id="reset-submit">Send Reset</button>
    </div>
  </form>
</dialog>

<dialog id="delete-dialog" class="modal">
  <form method="post" action="/admin/users/delete" id="delete-form">
    <div class="modal-header">
      <h2>Delete Account</h2>
      <p class="muted">This permanently deletes the user and their data.</p>
    </div>
    <div class="modal-body stack">
      <input type="hidden" name="user_id" id="delete-user-id" />
      <input type="hidden" name="q" value="{{.Query}}" />
      <div>
        <div class="label">User</div>
        <div class="pill" id="delete-user-label">User</div>
      </div>
      <label class="label" for="delete-confirm">Type DELETE to confirm</label>
      <input id="delete-confirm" name="confirm" type="text" autocomplete="off" placeholder="DELETE" required />
    </div>
    <div class="modal-actions">
      <button type="button" class="ghost" id="delete-cancel">Cancel</button>
      <button type="submit" class="danger" id="delete-submit" disabled>Delete account</button>
    </div>
  </form>
</dialog>

<script>
(() => {
  const dialog = document.getElementById("reset-dialog");
  const form = document.getElementById("reset-form");
  const userId = document.getElementById("reset-user-id");
  const userLabel = document.getElementById("reset-user-label");
  const userEmail = document.getElementById("reset-user-email");
  const deliverTo = document.getElementById("reset-deliver-to");
  const newEmail = document.getElementById("reset-new-email");
  const actionInput = document.getElementById("reset-action");
  const cancelBtn = document.getElementById("reset-cancel");
  const submitBtn = document.getElementById("reset-submit");
  const modeInputs = Array.from(form.querySelectorAll("input[name='mode']"));
  const hasSMTP = {{if .HasSMTP}}true{{else}}false{{end}};

  const setMode = (mode) => {
    actionInput.value = mode;
    const sendMode = mode === "send_user" || mode === "send_other";
    deliverTo.disabled = mode !== "send_other";
    deliverTo.required = mode === "send_other";
    newEmail.disabled = mode !== "update_email";
    newEmail.required = mode === "update_email";
    submitBtn.textContent = sendMode ? "Send Reset" : "Update Email";
  };

  const openDialog = (button) => {
    const id = button.dataset.userId;
    const email = button.dataset.userEmail;
    const name = button.dataset.username || "User";
    userId.value = id;
    userLabel.textContent = `@${name}`;
    userEmail.textContent = email ? `Current email: ${email}` : "No email on file.";
    deliverTo.value = "";
    newEmail.value = email || "";
    modeInputs[0].checked = true;
    setMode("send_user");
    submitBtn.disabled = !hasSMTP;
    if (dialog.showModal) {
      dialog.showModal();
    } else {
      dialog.setAttribute("open", "true");
    }
  };

  document.querySelectorAll(".reset-button").forEach((btn) => {
    btn.addEventListener("click", () => openDialog(btn));
  });
  modeInputs.forEach((input) => {
    input.addEventListener("change", (event) => {
      setMode(event.target.value);
      if (event.target.value === "update_email") {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = !hasSMTP;
      }
    });
  });
  cancelBtn.addEventListener("click", () => {
    if (dialog.close) {
      dialog.close();
    } else {
      dialog.removeAttribute("open");
    }
  });

  const deleteDialog = document.getElementById("delete-dialog");
  const deleteForm = document.getElementById("delete-form");
  const deleteUserId = document.getElementById("delete-user-id");
  const deleteUserLabel = document.getElementById("delete-user-label");
  const deleteConfirm = document.getElementById("delete-confirm");
  const deleteSubmit = document.getElementById("delete-submit");
  const deleteCancel = document.getElementById("delete-cancel");

  const updateDeleteState = () => {
    deleteSubmit.disabled = deleteConfirm.value.trim() !== "DELETE";
  };

  const openDeleteDialog = (button) => {
    const id = button.dataset.userId;
    const name = button.dataset.username || "User";
    deleteUserId.value = id;
    deleteUserLabel.textContent = `@${name}`;
    deleteConfirm.value = "";
    updateDeleteState();
    if (deleteDialog.showModal) {
      deleteDialog.showModal();
    } else {
      deleteDialog.setAttribute("open", "true");
    }
  };

  if (deleteForm) {
    deleteConfirm.addEventListener("input", updateDeleteState);
  }

  document.querySelectorAll(".delete-button").forEach((btn) => {
    btn.addEventListener("click", () => openDeleteDialog(btn));
  });
  deleteCancel.addEventListener("click", () => {
    if (deleteDialog.close) {
      deleteDialog.close();
    } else {
      deleteDialog.removeAttribute("open");
    }
  });
})();
</script>
{{end}}
{{define "users.html"}}{{template "layout" .}}{{end}}
